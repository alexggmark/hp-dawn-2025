{%- if section.settings.quick_add == 'standard' -%}
   <script src="{{ 'wm__quick-shop.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

<div class="section-{{ section.id }} _mb-{{ section.settings.margin_bottom | divided_by: 2 }} md:_mb-{{ section.settings.margin_bottom }} _py-20">
  <div class="">
    <product-card-carousel>
      <div class="_relative _overflow-hidden page-width--overflow-right">
        <div class="_grid _grid-cols-12">
          <div class="_col-span-3 _flex _flex-col _items-start _justify-center">
            {% unless section.settings.top_heading == blank %}
              <h3 class="_font-heading-small _text-brand-dark _text-sm _mb-2">
                {{ section.settings.top_heading }}
              </h3>
            {% endunless %}
            {% unless section.settings.main_heading == blank %}
              <h2 class="_font-heading-primary _text-brand-dark md:_text-4xl _text-2xl _mb-4">
                {{ section.settings.main_heading }}
              </h2>
            {% endunless %}
            <p class="_text-base _max-w-60">
              New arrivals, designed to support your skin and backed by science
            </p>
            {%- unless section.settings.cta_text == blank -%}
            <a
              href="{{ section.settings.collection.url }}"
              class="_button-primary _mt-6"
            >
              {{- section.settings.cta_text -}}
            </a>
          {%- endunless -%}
          </div>
          <div class="_col-span-9">
            <div
              class="js-product-carousel _flex _scrollbar _overflow-x-auto _snap-x _snap-mandatory md:_pb-0 _pb-2 md:_pr-20 _pr-4 _scroll-smooth _space-x-7{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
            >
              {% assign skip_card_product_styles = false %}
              {%- for product in section.settings.collection.products limit: section.settings.products_to_show -%}
                <div id="Slide-{{ section.id }}-{{ forloop.index }}"
                  class="
                  md:_w-1/2
                  md:_max-w-[380px]
                  _w-[220px]
                  _flex-none
                  _flex
                  _justify-center
                  _items-center
                  _snap-start
                  _h-auto
                ">
                  {% render 'wm__card-product',
                    card_product: product,
                    show_rating: section.settings.show_rating,
                    skip_styles: skip_card_product_styles,
                    section_id: section.id,
                    quick_add: section.settings.quick_add
                  %}
                </div>
                {%- assign skip_card_product_styles = true -%}
              {%- endfor -%}
            </div>
          </div>
        </div>
      </div>
      <div class="page-width _flex _justify-between _items-center _pt-2">
        <div class="_flex _justify-between _items-center _gap-2 md:_min-w-28 _min-w-24 _flex-shrink-0 md:_mt-0 _mt-2">
          <button
            type="button"
            class="js-previous-button _text-brand-primary-700 hover:_scale-110 _flex _items-center _justify-center _h-10 _rounded-full disabled:_opacity-40"
            name="previous"
            aria-label="Reverse scroll through product carousel"
            aria-controls="Slider-{{ section.id }}"
          >
            <span class="svg-wrapper _rotate-180 _w-4">
              {{- 'arrow-chevron.svg' | inline_asset_content -}}
            </span>
          </button>
          <div class="_text-center _text-brand-primary-700 _text-sm">
            <span class="js-counter">1</span> / <span class="js-total-slides">8</span>
          </div>
          <button
            type="button"
            class="js-next-button _text-brand-primary-700 hover:_scale-110 _flex _items-center _justify-center _h-10 _rounded-full disabled:_opacity-40"
            name="next"
            aria-label="Forward scroll through product carousel"
            aria-controls="carousel-{{ section.id }}"
          >
            <span class="svg-wrapper _w-4">
              {{- 'arrow-chevron.svg' | inline_asset_content -}}
            </span>
          </button>
        </div>
      </div>
    </product-card-carousel>
  </div>
</div>

<script>
  customElements.define('product-card-carousel', class ProductCardCarousel extends HTMLElement {
    constructor() {
      super();
      this.slideWidth = 280;
      this.spaceBetween = 8;
    }

    connectedCallback() {
      this.carousel = this.querySelector('.js-product-carousel');
      this.prevBtn = this.querySelector('.js-previous-button');
      this.nextBtn = this.querySelector('.js-next-button');
      this.counter = this.querySelector('.js-counter');
      this.totalSlidesElement = this.querySelector('.js-total-slides');
      this.slides = Array.from(this.carousel.children);
      this.totalSlides = this.slides.length;
      
      this.totalSlidesElement.textContent = this.totalSlides;
      
      this.prevBtn.addEventListener('click', () => this.navigateSlide(-1));
      this.nextBtn.addEventListener('click', () => this.navigateSlide(1));
      
      this.scrollHandler = this.debounce(() => this.updateCounterBasedOnScroll(), 50);
      this.carousel.addEventListener('scroll', this.scrollHandler);
      
      this.updateButtonState();
      
      this.resizeObserver = new ResizeObserver(() => this.updateCounterBasedOnScroll());
      this.resizeObserver.observe(this.carousel);
    }
    
    disconnectedCallback() {
      // Clean up event listeners
      this.carousel.removeEventListener('scroll', this.scrollHandler);
      if (this.resizeObserver) {
        this.resizeObserver.disconnect();
      }
    }
    
    debounce(func, wait) {
      let timeout;
      return function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this), wait);
      };
    }
    
    updateCounterBasedOnScroll() {
      const carouselRect = this.carousel.getBoundingClientRect();
      const rightEdgePosition = carouselRect.right;
      
      let rightmostVisibleIndex = 0;
      
      // Use binary search for better performance with large number of slides
      if (this.slides.length > 20) {
        rightmostVisibleIndex = this.findRightmostVisibleIndexBinary(rightEdgePosition);
      } else {
        // Original linear search for small collections
        for (let i = 0; i < this.slides.length; i++) {
          const slideRect = this.slides[i].getBoundingClientRect();
          if (slideRect.right <= rightEdgePosition + 1) {
            rightmostVisibleIndex = i;
          } else {
            break;
          }
        }
      }
      
      this.counter.textContent = rightmostVisibleIndex + 1;
      this.updateButtonState(rightmostVisibleIndex);
    }
    
    findRightmostVisibleIndexBinary(rightEdgePosition) {
      let low = 0;
      let high = this.slides.length - 1;
      let result = 0;
      
      while (low <= high) {
        const mid = Math.floor((low + high) / 2);
        const slideRect = this.slides[mid].getBoundingClientRect();
        
        if (slideRect.right <= rightEdgePosition + 1) {
          result = mid; // This slide is visible, but there might be more
          low = mid + 1;
        } else {
          high = mid - 1;
        }
      }
      
      return result;
    }
    
    navigateSlide(direction) {
      const currentScroll = this.carousel.scrollLeft;
      const newScroll = currentScroll + (direction * (this.slideWidth + this.spaceBetween));
      
      this.carousel.scrollTo({
        left: newScroll,
        behavior: 'smooth'
      });
    }
    
    updateButtonState(rightmostVisibleIndex) {
      const currentIndex = rightmostVisibleIndex ?? parseInt(this.counter.textContent) - 1;
      
      // Check if the first slide is visible
      const firstSlideRect = this.slides[0].getBoundingClientRect();
      const carouselRect = this.carousel.getBoundingClientRect();
      
      // Disable the back button if the first slide is visible
      this.prevBtn.disabled = firstSlideRect.left >= carouselRect.left;

      this.nextBtn.disabled = currentIndex >= this.totalSlides - 1;
    }
  });
</script>

{% schema %}
{
  "name": "WM Product Scroll",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "inline_richtext",
      "id": "top_heading",
      "default": "t:sections.footer.blocks.link_list.settings.heading.default",
      "label": "Top Heading"
    },
    {
      "type": "inline_richtext",
      "id": "main_heading",
      "default": "t:sections.footer.blocks.link_list.settings.heading.default",
      "label": "Main Heading"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "t:sections.featured-collection.settings.collection.label"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 25,
      "step": 1,
      "default": 8,
      "label": "t:sections.featured-collection.settings.products_to_show.label"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": false,
      "label": "t:sections.featured-collection.settings.show_rating.label",
      "info": "t:sections.featured-collection.settings.show_rating.info"
    },
    {
      "type": "select",
      "id": "quick_add",
      "default": "none",
      "label": "t:sections.main-collection-product-grid.settings.quick_add.label",
      "info": "t:sections.main-collection-product-grid.settings.quick_add.info",
      "options": [
        {
          "value": "none",
          "label": "t:sections.main-collection-product-grid.settings.quick_add.options.option_1"
        },
        {
          "value": "standard",
          "label": "t:sections.main-collection-product-grid.settings.quick_add.options.option_2"
        }
      ]
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "CTA Text",
      "default": "See all"
    },
    {
      "type": "header",
      "content": "Margin bottom controls"
    },
    {
      "type": "select",
      "id": "margin_bottom",
      "options": [
        {
          "value": "0",
          "label": "0rem"
        },
        {
          "value": "2",
          "label": "0.5rem"
        },
        {
          "value": "4",
          "label": "1rem"
        },
        {
          "value": "6",
          "label": "1.5rem"
        },
        {
          "value": "8",
          "label": "2rem"
        },
        {
          "value": "12",
          "label": "3rem"
        },
        {
          "value": "16",
          "label": "4rem"
        }
      ],
      "default": "12",
      "label": "Margin bottom"
    }
  ],
  "presets": [
    {
      "name": "WM Product Scroll"
    }
  ]
}
{% endschema %}
