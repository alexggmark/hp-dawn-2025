{% style %}
  .test {}
{% endstyle %}

<div class="_relative _overflow-hidden page-width--overflow-right _py-8">
  <recently-viewed-products 
    data-max-products="12"
  >
    <h2 class="_font-heading-primary _text-brand-dark md:_text-3xl _text-2.5xl md:_mb-4 _mb-3">
      Recently Viewed
    </h2>
    <template data-js-recentlyviewed-template>
      <div
        class="
        _w-[140px]
        md:_w-[180px]
        _flex-none
        _flex
        _justify-center
        _items-center
        _snap-start
        _h-auto
      ">
        {% comment %} TODO: START PRODUCT CARD {% endcomment %}
          {% assign card_product = settings.default_product %}
          <div class="_group _h-full _w-full _relative card-wrapper">
            <div
              class="
                _flex
                _flex-col
                _h-full
                card--{{ settings.card_style }}
                card--media
              "
            >
              {% comment %} _aspect-square {% endcomment %}
              <div
                class="
                  _relative
                  _box-border
                  _w-full
                  _aspect-[8/9]
                  _bg-brand-background
                  "
                >
                {%- if card_product.featured_media -%}
                  <div class="_absolute _inset-0 _overflow-hidden _z-0">
                    <div class="
                      _block
                      _bg-transparent
                      _overflow-hidden
                      _max-w-full
                      _absolute
                      _inset-0
                    ">
                      {% comment %}theme-check-disable ImgLazyLoading{% endcomment %}
                      <img
                        srcset="
                          {%- if card_product.featured_media.width >= 165 -%}{{ card_product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
                          {%- if card_product.featured_media.width >= 360 -%}{{ card_product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
                          {%- if card_product.featured_media.width >= 533 -%}{{ card_product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
                          {%- if card_product.featured_media.width >= 720 -%}{{ card_product.featured_media | image_url: width: 720 }} 720w,{%- endif -%}
                          {%- if card_product.featured_media.width >= 940 -%}{{ card_product.featured_media | image_url: width: 940 }} 940w,{%- endif -%}
                          {%- if card_product.featured_media.width >= 1066 -%}{{ card_product.featured_media | image_url: width: 1066 }} 1066w,{%- endif -%}
                          {{ card_product.featured_media | image_url }} {{ card_product.featured_media.width }}w
                        "
                        src="{{ card_product.featured_media | image_url: width: 533 }}"
                        sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
                        alt="{{ card_product.featured_media.alt | escape }}"
                        class="motion-reduce _object-contain _object-center _h-full _w-full"
                        {% unless lazy_load == false %}
                          loading="lazy"
                        {% endunless %}
                        width="{{ card_product.featured_media.width }}"
                        height="{{ card_product.featured_media.height }}"
                      >
                      {% comment %}theme-check-enable ImgLazyLoading{% endcomment %}
                    </div>
                  </div>
                {%- endif -%}
                <div class="_relative _grid _p-3 _w-full _h-full" style="grid-template-rows: minmax(0, 1fr) max-content minmax(0, 1fr)">
                  <div class="
                    _py-6 _px-4 md:_py-6 md:_px-7 _hidden
                  ">
                    <h3
                      class="
                        _mt-0
                        _mb-0
                      "
                      {% if card_product.featured_media == null and settings.card_style == 'standard' %}
                        id="title-{{ section_id }}-{{ card_product.id }}"
                      {% endif %}
                    >
                      <a
                        href="{{ card_product.url }}"
                        id="StandardCardNoMediaLink-{{ section_id }}-{{ card_product.id }}"
                        class="full-unstyled-link"
                        aria-labelledby="StandardCardNoMediaLink-{{ section_id }}-{{ card_product.id }} NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}"
                      >
                        {{ card_product.title | escape }}
                      </a>
                    </h3>
                  </div>
                </div>
              </div>
              <div
                class="p-0 _w-full"
              >
                {% comment %} Careful here, this _py also controls simple cards {% endcomment %}
                <div class="
                  _pt-2
                ">
                  <div class="
                    
                  ">
                    {% comment %} ----------------------- {% endcomment %}
                    {% comment %} -- (A) Product title -- {% endcomment %}
                    {% comment %} ----------------------- {% endcomment %}
                    <h3
                      class="_text-brand-dark _overflow-hidden _whitespace-nowrap"
                      {% if card_product.featured_media or settings.card_style == 'card' %}
                        id="title-{{ section_id }}-{{ card_product.id }}"
                      {% endif %}
                    >
                      <a
                        href="{{ card_product.url }}"
                        id="CardLink-{{ section_id }}-{{ card_product.id }}"
                        class="
                          _no-underline
                          _block
                          _font-semibold _text-brand-dark _text-sm
                          _overflow-hidden _text-ellipsis _whitespace-nowrap
                          after:_top-0
                          after:_left-0
                          after:_bottom-0
                          after:_right-0
                          after:_absolute
                          after:_z-0
                          _content-['']
                        "
                        aria-labelledby="CardLink-{{ section_id }}-{{ card_product.id }} Badge-{{ section_id }}-{{ card_product.id }}"
                      >
                        {{ card_product.title | escape }}
                      </a>
                    </h3>

                    {% comment %} --------------- {% endcomment %}
                    {% comment %} -- (B) Price -- {% endcomment %}
                    {% comment %} --------------- {% endcomment %}
                    {% comment %} Temporary class just to fix sizing {% endcomment %}
                    {% style %}
                      .related-products-price-controls .price {
                        font-size: 0.8rem!important;
                      }
                      .related-products-price-controls .price ._text-base {
                        font-size: 0.8rem!important;
                      }
                    {% endstyle %}
                    <div class="related-products-price-controls">
                      {% render 'wm__price', product: card_product, price_class: '', show_compare_at_price: true %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% comment %} TODO: END PRODUCT CARD {% endcomment %}
      </div>
    </template>

    <embla-slider>
      <div class="_relative _overflow-hidden" data-js-embla>
        <div class="_flex _gap-4 _select-none" data-js-embla-container data-limit="12">
          {% comment %} TODO: START RECENTLY VIEWED {% endcomment %}



          {% comment %} TODO: END RECENTLY VIEWED {% endcomment %}
        </div>
        <button data-js-embla-prev class="_absolute _rotate-180 _left-4 _top-1/2 _-translate-y-12 _bg-brand-light _text-brand-dark hover:_scale-110 md:_flex _hidden _items-center _justify-center _w-10 _h-10 _rounded-full _opacity-80 hover:_opacity-100 disabled:_opacity-0">
          <span class="svg-wrapper _w-5">
            {{- 'arrow-chevron.svg' | inline_asset_content -}}
          </span>
        </button>
        <button data-js-embla-next class="_absolute md:_right-7 _right-4 _top-1/2 _-translate-y-12  _bg-brand-light _text-brand-dark hover:_scale-110 _flex _items-center _justify-center _w-10 _h-10 _rounded-full _opacity-80 hover:_opacity-100 disabled:_opacity-0">
          <span class="svg-wrapper _w-5">
            {{- 'arrow-chevron.svg' | inline_asset_content -}}
          </span>
        </button>
      </div>
    </embla-slider>
  </recently-viewed-products>
</div>

<script>
  class RecentlyViewedProducts extends HTMLElement {
    constructor() {
      super();
      this.maxProducts = parseInt(this.getAttribute('data-max-products')) || 12;
      this.productHandles = [];
      this.emblaInstance = null;
    }

    connectedCallback() {
      this.init();
    }

    async init() {
      await this.loadProductHandles();
      if (this.productHandles.length > 0) {
        await this.renderProducts();
      } else {
        this.style.display = 'none';
      }
    }

    loadProductHandles() {
      try {
        const stored = localStorage.getItem('shopifyProductRecentlyViewed');
        this.productHandles = stored ? JSON.parse(stored) : [];
        
        const currentHandle = '{{ product.handle }}';
        this.productHandles = this.productHandles.filter(handle => handle !== currentHandle);
        
        this.productHandles = this.productHandles.slice(0, this.maxProducts);
      } catch (error) {
        console.error('Error loading recently viewed:', error);
        this.productHandles = [];
      }
    }

    async renderProducts() {      
      const container = this.querySelector('[data-js-embla-container]');
      const template = this.querySelector('[data-js-recentlyviewed-template]');
      
      if (!template) {
        console.error('Template not found');
        return;
      }

      const productPromises = this.productHandles.map(handle => 
        this.fetchProductData(handle).catch(error => {
          console.error(`Error loading product ${handle}:`, error);
          return null;
        })
      );
      
      const products = await Promise.all(productPromises);
      
      products.forEach((product, index) => {
        if (!product) return;
        
        const handle = this.productHandles[index];
        const clone = template.content.cloneNode(true);
        container.appendChild(clone);
        
        const cardElement = container.lastElementChild;
        this.updateProductCard(cardElement, product, handle);
      });
    }

    formatPrice(priceInCents) {
      const price = priceInCents / 100;
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP'
      }).format(price);
    }

    updateProductCard(cardElement, product, handle) {
      cardElement.setAttribute('data-product-handle', handle);
      
      const productLinks = cardElement.querySelectorAll('a');
      const productImage = cardElement.querySelector('img');
      
      const priceContainer = cardElement.querySelector('.price');
      const regularPrice = cardElement.querySelector('.price__regular');
      
      if (productLinks.length > 0) {
        productLinks.forEach(link => {
          link.href = product.url;
          link.textContent = product.title;
        });
      }
      
      if (productImage) {
        productImage.src = product.featured_image;
        productImage.srcset = '';
        productImage.alt = product.title;
      }
      
      if (priceContainer) {
        priceContainer.textContent = this.formatPrice(product.price);
      }
      if (regularPrice) {
        if (!product.compare_at_price) {
          regularPrice.closest('.price')?.querySelector('s')?.remove();
        } else {
          regularPrice.textContent = this.formatPrice(product.compare_at_price);
        }
      }
    }

    async fetchProductData(handle) {
      const response = await fetch(`/products/${handle}.js`);
      if (!response.ok) throw new Error('Product not found');
      return response.json();
    }
  }

  customElements.define('recently-viewed-products', RecentlyViewedProducts);
</script>
